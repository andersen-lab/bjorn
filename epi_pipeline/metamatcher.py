#!/usr/bin/env python
# coding: utf-8

import pandas as pd
import numpy as np
import json
import sys

# prep geo data
print("prepping geo data", file=sys.stderr)
loc_lookup = pd.read_csv("UID_ISO_FIPS_LookUp_Table.csv")
countries_geo = pd.read_csv("countries_geo.tsv", sep="\t", header=None, names=["ID", "name", "geometry"])
countries_geo.loc[:, "geometry"] = countries_geo["geometry"].apply(json.loads)
countries_geo.loc[countries_geo["name"] == "United States of America", "name"] = "US"
countries_geo.loc[countries_geo["name"] == "Dominican Rep.", "name"] = "Dominican Republic"
countries_geo.loc[countries_geo["name"] == "Bosnia and Herz.", "name"] = "Bosnia and Herzegovina"
countries_geo.loc[countries_geo["name"] == "Myanmar", "name"] = "Burma"
countries_geo.loc[countries_geo["name"] == "South Korea", "name"] = "Korea, South"
countries_geo.loc[countries_geo["name"] == "CÃ´te d'Ivoire", "name"] = "Cote d'Ivoire"
countries_geo.loc[countries_geo["name"] == "Congo", "name"] = "Congo (Brazzaville)"
countries_geo.loc[countries_geo["name"] == "Dem. Rep. Congo", "name"] = "Congo (Kinshasa)"
countries_geo.loc[countries_geo["name"] == "Central African Rep.", "name"] = "Central African Republic"
countries_geo.loc[countries_geo["name"] == "eSwatini", "name"] = "Eswatini"
countries_geo.loc[countries_geo["name"] == "Eq. Guinea", "name"] = "Equatorial Guinea"
countries_geo.loc[countries_geo["name"] == "Macedonia", "name"] = "North Macedonia"
countries_geo.loc[countries_geo["name"] == "S. Sudan", "name"] = "South Sudan"
countries_geo = countries_geo.append({"name": "Bahrain", "ID": "BHR", "geometry":{"type":"Polygon","coordinates":[[[50.55160566500007,26.194240627000056],[50.56560306100005,26.198879299000055],[50.594086134000065,26.19529857000009],[50.603526238000086,26.197658596000053],[50.60914147200003,26.208319403000075],[50.60694420700008,26.21238841400009],[50.60474694100009,26.216498114000046],[50.59742272200003,26.225531317000048],[50.59327233200008,26.23859284100007],[50.586680535000085,26.24249909100007],[50.54550214900007,26.227769273000035],[50.54542076900003,26.227728583000044],[50.53239993600005,26.23309967700004],[50.516368035000085,26.23969147300005],[50.503916863000086,26.242010809000078],[50.48259524800005,26.242539781000062],[50.48161868600005,26.242539781000062],[50.481455925000034,26.242580471000053],[50.46851647200003,26.236883856000077],[50.46119225400008,26.22524648600006],[50.449554884000065,26.17796458500004],[50.44890384200005,26.16160716400009],[50.45297285200007,26.149562893000052],[50.46998131600009,26.12262604400007],[50.48519941500007,26.085638739000046],[50.490896030000044,26.048000393000052],[50.485443556000064,26.03343333500004],[50.47999108200008,26.018866278000075],[50.46045983200008,25.985296942000048],[50.467784050000034,25.957586981000077],[50.51140384200005,25.913031317000048],[50.53142337300005,25.885239976000037],[50.547211134000065,25.85293203300006],[50.558604363000086,25.81976959800005],[50.56527754000007,25.789536851000037],[50.565440300000034,25.78969961100006],[50.594493035000085,25.83270905200004],[50.603526238000086,25.85455963700008],[50.61841881600009,25.96474844000005],[50.62061608200008,26.05296458500004],[50.61475670700008,26.111151434000078],[50.63492579390065,26.115694488343305],[50.63550651826553,26.134382379256266],[50.64565981318161,26.145749742329986],[50.63277899004446,26.146823144258082],[50.62633857847588,26.170437986676188],[50.61989816690731,26.18546561366953],[50.60487053991397,26.17473159438857],[50.594737175000034,26.160305080000057],[50.55160566500007,26.194240627000056]]]}}, ignore_index=True)
countries_geo = countries_geo.append({"name": "Andorra", "ID": "AND", "geometry":{"type":"Polygon","coordinates":[[[1.707006470000067,42.50278147400006],[1.7106238200001371,42.52774119100006],[1.7216825770001378,42.54851511600002],[1.7399760330001186,42.56164093000005],[1.7650907800001505,42.56337209100003],[1.761107147000132,42.567646197],[1.752688435000067,42.57667877200005],[1.7294340410000757,42.5820014450001],[1.7133109950000858,42.58954620400006],[1.7219926350000492,42.60985504200006],[1.6083044840001435,42.618123271000016],[1.5973490810000612,42.62192148900006],[1.5430888270001333,42.64936167400002],[1.527792602000062,42.64853485200008],[1.498440389000109,42.64024078400003],[1.4668144120001045,42.64145518000005],[1.4514148360001116,42.60205190100005],[1.4292973220001102,42.59538564100005],[1.4248531500001036,42.589365336000085],[1.419272095000082,42.57926259400004],[1.4180318600000419,42.56983164500009],[1.4264034420001224,42.56564585400007],[1.4263000900000975,42.561795960000026],[1.4097636310000894,42.54060862200005],[1.4064563390001013,42.52923980800007],[1.4289872640001136,42.53146189400006],[1.4465572510000868,42.51988637400002],[1.449967895000043,42.50407338400002],[1.4302274980000789,42.493557231000054],[1.4245430900000144,42.49247202600007],[1.4075932210000985,42.48676178000004],[1.4364286700000548,42.453482158000085],[1.4364286700000548,42.44095062300006],[1.4479008380000664,42.43464609800007],[1.5084656170001267,42.42867747000004],[1.5166304930001218,42.42950429300005],[1.5282060140000908,42.434232686000044],[1.5345105390001095,42.43991709400008],[1.5388513590000912,42.44565317800006],[1.5444324140000845,42.45035573400013],[1.6074776610001322,42.45642771400007],[1.6395170490001192,42.466427104000005],[1.6503691000000913,42.49340220200013],[1.653986450000076,42.496528626000085],[1.6569836830000781,42.497639669000066],[1.659774210000137,42.496812846000054],[1.6623580320000428,42.49371226000001],[1.6742436110000654,42.490508321000036],[1.6863358960000596,42.49061167500007],[1.6974980060000746,42.49446156900011],[1.707006470000067,42.50278147400006]]]}}, ignore_index=True)
countries_geo = countries_geo.append({"name": "Maldives", "ID": "MDV", "geometry":{"type":"Polygon","coordinates":[[[73.16309655000003,-0.6818173159999219],[73.16358483200008,-0.6866187479999439],[73.16586347700007,-0.6884091129999206],[73.17253665500004,-0.6885718729999439],[73.16309655000003,-0.6818173159999219]]]}}, ignore_index=True)
countries_geo = countries_geo.append({"name": "Malta", "ID": "MLT", "geometry":{"type":"Polygon","coordinates":[[[14.332530144000089,36.018866278000075],[14.325450066000087,36.01911041900007],[14.321787957000083,36.01699453300006],[14.323171420000051,36.01166413000004],[14.32585696700005,36.006374416000085],[14.324636264000048,36.00344472900008],[14.327321811000047,36.003892320000034],[14.327972852000073,36.00328196800007],[14.338145379000082,36.00454336100006],[14.350596550000091,36.00950755400004],[14.343597852000073,36.01557038000004],[14.332530144000089,36.018866278000075]]]}}, ignore_index=True)
countries_geo = countries_geo.append({"name": "Seychelles", "ID": "SYC", "geometry":{"type":"Polygon","coordinates":[[[52.74187259200005,-6.994317315999922],[52.742198113000086,-6.9984677059999285],[52.742198113000086,-7.001722914999959],[52.74341881600009,-7.004082940999922],[52.74724368600005,-7.005059502999927],[52.74187259200005,-6.994317315999922]]]}}, ignore_index=True)
countries_geo = countries_geo.append({"name": "Singapore", "ID": "SGP", "geometry":{"type":"Polygon","coordinates":[[[103.96078535200007,1.3910993510000935],[103.93246504000007,1.4011091170000896],[103.85718834700003,1.4387067730000922],[103.83155358200003,1.447088934000078],[103.80494225400008,1.4486351580000587],[103.79004967500003,1.4442813170000477],[103.76221764400003,1.4309756530000755],[103.73975670700003,1.4281273460000534],[103.71794681100005,1.4309756530000755],[103.70834394600007,1.4293887390000464],[103.69507897200003,1.4213320980000503],[103.68384850400008,1.409898179000038],[103.67888431100005,1.3992373720000728],[103.67457116000003,1.3803164730000503],[103.64470462300005,1.3380394550000574],[103.64039147200003,1.3222516950000909],[103.64763431100005,1.308417059000078],[103.66529381600003,1.3041039080000587],[103.70875084700003,1.3052432310000768],[103.73015384200005,1.302923895000049],[103.75513756600003,1.2971052100000406],[103.77588951900003,1.2875837260000935],[103.78443444100003,1.273871161000045],[103.78956139400003,1.2678897160000702],[103.80160566500007,1.264797268000052],[103.82601972700007,1.26430898600006],[103.83887780000003,1.26626211100006],[103.84408613400007,1.2685000670000477],[103.84693444100003,1.271918036000045],[103.85271243600005,1.2772891300000424],[103.88770592500003,1.3012556010000935],[103.90723717500003,1.3087425800000574],[103.93189537900008,1.3114688170000477],[103.95435631600003,1.318101304000038],[103.97486412900008,1.3344587260000935],[103.99187259200005,1.3549258480000503],[104.00342858200003,1.374172268000052],[103.99952233200003,1.3803164730000503],[103.98568769600007,1.385443427000041],[103.96078535200007,1.3910993510000935]]]}}, ignore_index=True)
countries_geo = countries_geo.append({"name": "West Bank and Gaza", "ID": "WBG", "geometry":{"type":"MultiPolygon","coordinates":[[[[34.48120412500009,31.58314132300005],[34.47877037900008,31.578273830000057],[34.443369988000086,31.53457265800006],[34.368174675000034,31.46816640800006],[34.348399285000085,31.437648830000057],[34.30160566500007,31.40770091400009],[34.28142337300005,31.376695054000038],[34.236664259000065,31.342352606000077],[34.222666863000086,31.326646226000037],[34.200269441306034,31.314266688845734],[34.22460819500009,31.275714824000104],[34.23039595600011,31.259230041000123],[34.24835085700005,31.211448958000076],[34.26439904800014,31.224193420000105],[34.315868775000126,31.25690460200009],[34.350905396000144,31.289254049000093],[34.35379927600013,31.306358948000124],[34.345531046000076,31.340723776000075],[34.345841105000034,31.357725322000093],[34.36733850100012,31.392813619000023],[34.48040653500004,31.485624492000042],[34.495496054000114,31.49440948500002],[34.495702759000096,31.49440948500002],[34.52825891100014,31.520144348000102],[34.5304293210001,31.541383362000076],[34.51141239400005,31.561588847000067],[34.48120412500009,31.58314132300005]]],[[[35.560960734000105,32.384716899000026],[35.48013879400014,32.40241607700004],[35.456677694000064,32.40760955900005],[35.4328031820001,32.40825551400012],[35.406861613000046,32.41479258200009],[35.40138391100004,32.44001068100006],[35.40179732200005,32.47096486400007],[35.39290897600006,32.494477641000046],[35.363143351000076,32.510109762000084],[35.333377726000094,32.513081157],[35.27043583200009,32.5104714970001],[35.25224572700006,32.51594919800009],[35.22372033700009,32.5358963020001],[35.210359354000104,32.54186756300008],[35.208630819000064,32.54264007600004],[35.19075077300005,32.54170990000007],[35.17679813700005,32.53269236300004],[35.15168339100012,32.507913513000105],[35.12067753100007,32.491325379],[35.09070520000006,32.47923309400001],[35.06435021900006,32.46313588500003],[35.04471317500014,32.43411956800004],[35.03273030100007,32.382200260999994],[35.02879683500004,32.3651573690001],[35.02156213400008,32.34459014900004],[35.017841431000136,32.34221303300008],[35.00450891100013,32.33805308100004],[35.00068485500009,32.33572764100002],[34.99655074100008,32.32304107700007],[34.99303674300012,32.291570130000125],[34.98993615800009,32.27847015400006],[35.00244185400004,32.275137024000045],[35.00936649600004,32.26764394200002],[35.01112349400012,32.257101949000045],[35.007609497000146,32.2443895470001],[35.00027144400008,32.23201304100003],[34.96141076700013,32.20157562300007],[34.94807824700007,32.18687367800008],[34.946114542000146,32.17726186100005],[34.96234094300007,32.14635935500006],[34.967301880000036,32.129461161000066],[34.97991092900014,32.03520334900007],[34.98042769400007,32.016548157],[34.97867069500012,31.99437896700006],[34.97867069500012,31.99370717400008],[34.97898075300009,31.993087057000125],[34.97960087100006,31.99257029200008],[34.98032434100014,31.99215688100007],[34.98115116300005,31.988849589000054],[34.98146122300005,31.98523223900007],[34.98115116300005,31.981614889000085],[34.98032434100014,31.978204244000082],[34.9760868730001,31.94823191300013],[34.99582727000006,31.90916453100003],[35.007712850000075,31.875678202000117],[34.98032434100014,31.86260406500007],[34.95324589000012,31.854439189000047],[34.94732619400014,31.840925146000117],[34.94539107300005,31.83650746700006],[34.95479618300004,31.819764303000042],[34.98776574700008,31.814803366000078],[35.00337203000004,31.814648336000047],[35.01050337800007,31.81588857000007],[35.02042525200005,31.82115956700001],[35.03809859200004,31.837385966000014],[35.045539999000084,31.841416728000112],[35.05969934000012,31.83940134700005],[35.11189253800012,31.81805898100005],[35.18144901500011,31.80410634400006],[35.198398885000074,31.795166321000053],[35.20625370300013,31.782763977000073],[35.208010701000035,31.76612416600004],[35.20656376100004,31.744626771000114],[35.2028430580001,31.738942363000078],[35.19829553200009,31.737702129000027],[35.193127889000095,31.739872539000103],[35.187443481000116,31.744471741000055],[35.12574182100008,31.73310292500007],[35.10672489400008,31.724938050000063],[35.088844849000054,31.712587382000024],[35.054014934000065,31.68220164000006],[34.97360640500011,31.630370178000064],[34.95531294800014,31.611870016000054],[34.95317554300004,31.608319958000024],[34.93732954900008,31.58200103800003],[34.93288537600006,31.554922588000053],[34.93247196500005,31.52696563700006],[34.926787557000125,31.49440948500002],[34.88172570800015,31.429865621000076],[34.86715295400012,31.396430969999997],[34.878831827000056,31.362841289000087],[34.90094934100006,31.34847524000007],[34.92740767400005,31.3449095670001],[34.95489953600014,31.348630270000015],[34.98032434100014,31.356175029000056],[35.04016564900013,31.36320302400007],[35.16491255700009,31.362272848000103],[35.22330692500009,31.381031393000015],[35.3323441980001,31.458804423000046],[35.39011844900011,31.487071432000036],[35.45812463400006,31.491929016000043],[35.45874475100004,31.49156728100006],[35.45915816300004,31.49187734000013],[35.45905481000011,31.4928075160001],[35.45874475100004,31.49440948500002],[35.46422245300005,31.568565165000066],[35.48013879400014,31.64111887600008],[35.50247856700008,31.685360389000024],[35.527577758000064,31.73506663000002],[35.55941044100007,31.765349019000055],[35.53832645600005,31.8192992150001],[35.53832645600005,31.826740621000013],[35.54907515400009,31.839194641000105],[35.524683879000065,31.919241435000046],[35.527474406000124,31.92735463500007],[35.53367557700011,31.930300192000047],[35.5406002200001,31.932005514000124],[35.54514774600011,31.936604716000076],[35.54587121600014,31.944562887000032],[35.53998010300012,31.955621643000043],[35.53832645600005,31.963941549000097],[35.53770634000011,31.977584127000014],[35.535535929000105,31.988229473000004],[35.524683879000065,32.01169057200006],[35.52282352700007,32.0578376270001],[35.528301229000135,32.075097555000085],[35.54514774600011,32.086828105000095],[35.53460575300005,32.099230449000046],[35.53522587100014,32.11080596900011],[35.55196903500007,32.13519724500013],[35.546698038000045,32.141605123000076],[35.546698038000045,32.14703114900006],[35.5512455650001,32.15152699800008],[35.55941044100007,32.15509267200004],[35.55941044100007,32.162534079000054],[35.55517297300014,32.17439381999999],[35.55956241700005,32.19037087200006],[35.572536255000045,32.23759409600005],[35.55941044100007,32.23759409600005],[35.561064087000034,32.24314931200006],[35.56375126100005,32.24681833900006],[35.56757531800008,32.24950551400009],[35.572536255000045,32.25190846800005],[35.56457808400012,32.26358734200001],[35.56085738100006,32.28263010700009],[35.56116744000008,32.30169871100007],[35.5656116130001,32.31335174500005],[35.556516560000034,32.32820872000006],[35.557343384000035,32.35820688900013],[35.55196903500007,32.367947896000075],[35.55196903500007,32.37482086200005],[35.55941044100007,32.37482086200005],[35.55941044100007,32.367947896000075],[35.5656116130001,32.367947896000075],[35.563957967000135,32.37704294900006],[35.560960734000105,32.384716899000026]]]]}}, ignore_index=True)
countries_geo = countries_geo.append({"name": "Cabo Verde", "ID": "CBV", "geometry":{"type":"Polygon","coordinates":[[[-24.704335089999915,14.900824286000045],[-24.719349738999938,14.89443594000005],[-24.737619594999956,14.89203522300005],[-24.74941972599993,14.88548411700009],[-24.745350714999915,14.86664459800005],[-24.758941209999932,14.86664459800005],[-24.754709438999953,14.857855536000045],[-24.753244594999956,14.849351304000038],[-24.754709438999953,14.84080638200004],[-24.758941209999932,14.831854559000078],[-24.75153561099995,14.838771877000056],[-24.744618292999917,14.826605536000045],[-24.725453253999945,14.814113674000055],[-24.718006964999915,14.803941148000092],[-24.710560675999943,14.803941148000092],[-24.704416469999956,14.814032294000071],[-24.695301886999914,14.81940338700008],[-24.686879035999937,14.826646226000037],[-24.683257615999935,14.842474677000041],[-24.683949347999942,14.859442450000074],[-24.686756964999915,14.876166083000044],[-24.693104620999918,14.890692450000074],[-24.704335089999915,14.900824286000045]]]}}, ignore_index=True)
countries_geo = countries_geo.append({"name": "Saint Lucia", "ID": "LCA", "geometry":{"type":"Polygon","coordinates":[[[-60.886789516999954,14.01007721600007],[-60.89020748599995,14.052232164000088],[-60.89297441299993,14.06468333500004],[-60.90103105399993,14.073391018000052],[-60.91193600199995,14.079494533000059],[-60.91860917899993,14.088446356000077],[-60.914133266999954,14.10569896000004],[-60.93346106699994,14.111883856000077],[-60.94762122299994,14.10228099200009],[-60.97207597599993,14.068101304000038],[-60.97606360599991,14.06118398600006],[-60.97996985599991,14.043524481000077],[-60.98232988199993,14.03733958500004],[-60.98729407499991,14.032538153000075],[-60.99705969999991,14.027167059000078],[-61.00226803299995,14.023138739000046],[-61.026600714999915,13.98737213700008],[-61.03555253799993,13.964911200000074],[-61.059478318999936,13.931219794000071],[-61.06493079299992,13.917303778000075],[-61.06688391799992,13.909002997000073],[-61.07591712099992,13.890366929000038],[-61.07852128799993,13.879787502000056],[-61.078114386999914,13.869614976000037],[-61.07559160099993,13.86326732000009],[-61.07274329299992,13.858221747000073],[-61.071156378999945,13.85179271000004],[-61.07005774599992,13.832098700000074],[-61.071156378999945,13.821966864000046],[-61.078114386999914,13.806301174000055],[-61.074208136999914,13.79873281500005],[-61.06810462099992,13.792181708000044],[-61.06493079299992,13.786932684000078],[-61.0481664699999,13.767320054000038],[-60.97337805899991,13.73899974200009],[-60.955067511999914,13.714667059000078],[-60.950103318999936,13.714667059000078],[-60.94701087099992,13.716294664000088],[-60.94078528599994,13.72211334800005],[-60.931752081999946,13.760321356000077],[-60.92711341099994,13.769924221000053],[-60.92284094999991,13.772691148000092],[-60.91030839799993,13.77610911700009],[-60.90729732999995,13.77732982000009],[-60.90461178299995,13.78424713700008],[-60.89220130099994,13.833197333000044],[-60.895090298999946,13.877346096000053],[-60.88304602799991,13.954413153000075],[-60.88296464799993,13.980617580000057],[-60.886789516999954,14.01007721600007]]]}}, ignore_index=True)
countries_geo = countries_geo.append({"name": "Mauritius", "ID": "MUS", "geometry":{"type":"Polygon","coordinates":[[[57.79574629000007,-20.22275155999995],[57.791351759000065,-20.21217213299991],[57.772146030000044,-20.190524997999944],[57.76254316500007,-20.162041924999926],[57.75220787900008,-20.154229424999926],[57.744476759000065,-20.14381275799991],[57.74773196700005,-20.111504815999922],[57.744802280000044,-20.105075778999947],[57.73365319100009,-20.09612395599993],[57.72974694100009,-20.095147393999923],[57.71794681100005,-20.09693775799991],[57.713877800000034,-20.09612395599993],[57.70883222700007,-20.08993905999995],[57.70622806100005,-20.078383070999905],[57.69776451900003,-20.064060153999947],[57.690196160000085,-20.04729583099993],[57.68311608200008,-20.037774346999925],[57.67920983200008,-20.02825286299992],[57.68482506600009,-20.01100025799991],[57.679698113000086,-19.999932549999926],[57.66773522200003,-19.994073174999926],[57.62289472700007,-19.98170338299991],[57.60710696700005,-19.97942473799992],[57.59652754000007,-19.982598565999922],[57.590505405000044,-19.989678643999923],[57.58611087300005,-19.996758721999925],[57.58033287900008,-19.999932549999926],[57.56690514400003,-20.00090911299992],[57.56006920700008,-20.003838799999926],[57.53248131600009,-20.024834893999923],[57.528086785000085,-20.030857028999947],[57.52198326900003,-20.04159921699994],[57.50961347700007,-20.07740650799991],[57.494476759000065,-20.103692315999922],[57.49382571700005,-20.12232838299991],[57.49073326900003,-20.140801690999922],[57.473643425000034,-20.15748463299991],[57.463877800000034,-20.161553643999923],[57.44223066500007,-20.167413018999923],[57.432627800000034,-20.171807549999926],[57.410492384000065,-20.18922291499996],[57.40845787900008,-20.19231536299992],[57.40015709700003,-20.200616143999923],[57.37745201900003,-20.24309661299992],[57.37061608200008,-20.260511976999908],[57.365977410000085,-20.29078541499996],[57.36500084700003,-20.345961195999905],[57.35694420700008,-20.37037525799991],[57.367849155000044,-20.376153252999927],[57.36898847700007,-20.38640715899993],[57.36378014400003,-20.41448333099993],[57.357758009000065,-20.42742278399993],[57.344086134000065,-20.429864190999922],[57.319346550000034,-20.42506275799991],[57.303477410000085,-20.43092213299991],[57.30787194100009,-20.44426848799992],[57.32056725400008,-20.458184502999927],[57.37810306100005,-20.507012627999927],[57.39926191500007,-20.497979424999926],[57.42693118600005,-20.50090911299992],[57.473643425000034,-20.515069268999923],[57.50359134200005,-20.51734791499996],[57.58838951900003,-20.50481536299992],[57.672211134000065,-20.479668877999927],[57.68474368600005,-20.47161223799992],[57.692393425000034,-20.46152109199994],[57.705821160000085,-20.43873463299991],[57.711273634000065,-20.435804945999905],[57.71762129000007,-20.43613046699994],[57.723317905000044,-20.434258721999925],[57.72681725400008,-20.42506275799991],[57.72608483200008,-20.41961028399993],[57.720713738000086,-20.41106536299992],[57.71998131600009,-20.40398528399993],[57.71225019600007,-20.387465101999908],[57.729258660000085,-20.363946221999925],[57.75709069100009,-20.343357028999947],[57.78150475400008,-20.33570728999996],[57.77588951900003,-20.32040780999995],[57.77816816500007,-20.30478280999995],[57.78891035200007,-20.274183851999908],[57.793955925000034,-20.246758721999925],[57.79574629000007,-20.22275155999995]]]}}, ignore_index=True)
countries_geo = countries_geo.append({"name": "Barbados", "ID": "BRB", "geometry":{"type":"Polygon","coordinates":[[[-59.42690995999993,13.16038646000004],[-59.43862870999993,13.17487213700008],[-59.457102016999954,13.183172919000071],[-59.476673956999946,13.189398505000042],[-59.49181067599994,13.197943427000041],[-59.51805579299992,13.21751536700009],[-59.53661048099991,13.231390692000048],[-59.54979407499991,13.249172268000052],[-59.56895911399994,13.289658921000068],[-59.57591712099992,13.304388739000046],[-59.58071855399993,13.314520575000074],[-59.59447180899991,13.334784247000073],[-59.61286373599995,13.344549872000073],[-59.630930141999954,13.337958075000074],[-59.64513098899994,13.323716539000088],[-59.65221106699994,13.310614325000074],[-59.65420488199993,13.295111395000049],[-59.64606686099995,13.16038646000004],[-59.63312740799995,13.115912177000041],[-59.62157141799992,13.09398021000004],[-59.60814368399991,13.084662177000041],[-59.60024980399993,13.084133205000057],[-59.58690344999991,13.083197333000044],[-59.564442511999914,13.07802969000005],[-59.54596920499995,13.067694403000075],[-59.53612219999991,13.051174221000053],[-59.529286261999914,13.05540599200009],[-59.523101365999935,13.056463934000078],[-59.51671301999994,13.056382554000038],[-59.50885982999995,13.057318427000041],[-59.487538214999915,13.078558661000045],[-59.475778774999924,13.086493231000077],[-59.45571855399993,13.100043036000045],[-59.43004309799994,13.125921942000048],[-59.42690995999993,13.16038646000004]]]}}, ignore_index=True)
countries_geo = countries_geo.append({"name": "Antigua and Barbuda", "ID": "ATG", "geometry":{"type":"MultiPolygon","coordinates":[[[[-61.88361568899995,17.04901764500005],[-61.89037024599992,17.03538646000004],[-61.883656378999945,17.026271877000056],[-61.85171464799993,17.007635809000078],[-61.83869381399995,17.004828192000048],[-61.81786048099991,17.00495026200008],[-61.80406653599994,17.00731028900009],[-61.78359941299993,17.016913153000075],[-61.77684485599991,17.01854075700004],[-61.76976477799991,17.010972398000092],[-61.75352942599994,16.99681224200009],[-61.73713131399995,16.98924388200004],[-61.72964433499993,17.001166083000044],[-61.734364386999914,17.025783596000053],[-61.73399817599994,17.034857489000046],[-61.726226365999935,17.03847890800006],[-61.70995032499991,17.03416575700004],[-61.69701087099992,17.027818101000037],[-61.68569902299993,17.028550523000092],[-61.67442786399994,17.04588450700004],[-61.67218990799995,17.057562567000048],[-61.6770727199999,17.062933661000045],[-61.685658331999946,17.06826406500005],[-61.69493567599994,17.079413153000075],[-61.68814042899993,17.078924872000073],[-61.674387173999946,17.079901434000078],[-61.66759192599994,17.079413153000075],[-61.67210852799991,17.090643622000073],[-61.67552649599992,17.09560781500005],[-61.68065344999991,17.100531317000048],[-61.68809973899994,17.100531317000048],[-61.70164954299992,17.093451239000046],[-61.714833136999914,17.093085028000075],[-61.72508704299992,17.09983958500004],[-61.72964433499993,17.114162502000056],[-61.72052975199995,17.116115627000056],[-61.71629798099991,17.118801174000055],[-61.71349036399994,17.12254466400009],[-61.70860755099994,17.127834377000056],[-61.72008216099994,17.12636953300006],[-61.72984778599994,17.12799713700008],[-61.7376195949999,17.132961330000057],[-61.74331620999993,17.141506252000056],[-61.75275631399995,17.12889232000009],[-61.75544186099995,17.12303294500009],[-61.756418423999946,17.114162502000056],[-61.77301998599995,17.12653229400007],[-61.78066972599993,17.14716217700004],[-61.79336503799993,17.164943752000056],[-61.82526607999995,17.168768622000073],[-61.83967037699995,17.159857489000046],[-61.84878495999993,17.14948151200008],[-61.850453253999945,17.137640692000048],[-61.842355923999946,17.12441640800006],[-61.86538652299993,17.11782461100006],[-61.88312740799995,17.110500393000052],[-61.89415442599994,17.100531317000048],[-61.87336178299995,17.089544989000046],[-61.86620032499991,17.086859442000048],[-61.88243567599994,17.07880280200004],[-61.882801886999914,17.07021719000005],[-61.87922115799995,17.06045156500005],[-61.88361568899995,17.04901764500005]]],[[[-61.83893795499995,17.59332916900007],[-61.79474850199995,17.576117255000042],[-61.77696692599994,17.563421942000048],[-61.77065995999993,17.54555898600006],[-61.753570115999935,17.55149974200009],[-61.74327551999994,17.550604559000078],[-61.736398891999954,17.554022528000075],[-61.72964433499993,17.572821356000077],[-61.727772589999915,17.588446356000077],[-61.72874915299991,17.60496653900009],[-61.73591061099995,17.634914455000057],[-61.74327551999994,17.65135325700004],[-61.75426184799994,17.668768622000073],[-61.76817786399994,17.68463776200008],[-61.78429114499994,17.69635651200008],[-61.79727128799993,17.69879791900007],[-61.81822669199994,17.691839911000045],[-61.83145097599993,17.69635651200008],[-61.82457434799994,17.699367580000057],[-61.81786048099991,17.703192450000074],[-61.83779863199993,17.727687893000052],[-61.851673956999946,17.72028229400007],[-61.85643469999991,17.70107656500005],[-61.84919186099995,17.69013092700004],[-61.83120683499993,17.680487372000073],[-61.82502193899995,17.657945054000038],[-61.82648678299995,17.632473049000055],[-61.83145097599993,17.613836981000077],[-61.84316972599993,17.62018463700008],[-61.84316972599993,17.62958405200004],[-61.83922278599994,17.641424872000073],[-61.83893795499995,17.655422268000052],[-61.84422766799992,17.665961005000042],[-61.86009680899991,17.68423086100006],[-61.86620032499991,17.69635651200008],[-61.86782792899993,17.70408763200004],[-61.86937415299991,17.70734284100007],[-61.873036261999914,17.710638739000046],[-61.87385006399995,17.691148179000038],[-61.86974036399994,17.675482489000046],[-61.86392167899993,17.66014232000009],[-61.859364386999914,17.641791083000044],[-61.85728919199994,17.60097890800006],[-61.85179602799991,17.58657461100006],[-61.83893795499995,17.59332916900007]]]]}}, ignore_index=True)
countries_geo = countries_geo.append({"name": "Comoros", "ID": "COM", "geometry":{"type":"Polygon","coordinates":[[[43.78874759200005,-12.308038018999923],[43.779307488000086,-12.297621351999908],[43.727224155000044,-12.263604424999926],[43.70834394600007,-12.25790780999995],[43.666351759000065,-12.25009530999995],[43.65211022200003,-12.242608330999929],[43.635752800000034,-12.236911716999941],[43.629893425000034,-12.25172291499996],[43.63103274800005,-12.287774346999925],[43.63396243600005,-12.301039320999905],[43.64112389400009,-12.30641041499996],[43.65023847700007,-12.31023528399993],[43.658946160000085,-12.318291924999926],[43.66179446700005,-12.327732028999947],[43.660817905000044,-12.34498463299991],[43.66521243600005,-12.35247161299992],[43.68140709700003,-12.358086846999925],[43.75147545700008,-12.359958591999941],[43.819346550000034,-12.373467705999929],[43.84294681100005,-12.373467705999929],[43.858164910000085,-12.371351820999905],[43.86158287900008,-12.36337655999995],[43.85010826900009,-12.346123955999929],[43.79704837300005,-12.311618747999944],[43.78874759200005,-12.308038018999923]]]}}, ignore_index=True)
countries_geo = countries_geo.append({"name": "Dominica", "ID": "DMA", "geometry":{"type":"Polygon","coordinates":[[[-61.36286373599995,15.20180898600006],[-61.35073808499993,15.205145575000074],[-61.34638424399992,15.211696682000081],[-61.34593665299991,15.21234772300005],[-61.342681443999936,15.219671942000048],[-61.32872473899994,15.22557200700004],[-61.32359778599994,15.23859284100007],[-61.31818600199995,15.243394273000092],[-61.31187903599994,15.244533596000053],[-61.30337480399993,15.242580471000053],[-61.29320227799991,15.243882554000038],[-61.28929602799991,15.24359772300005],[-61.284413214999915,15.244818427000041],[-61.27721106699994,15.25023021000004],[-61.25666256399995,15.285345770000049],[-61.25373287699995,15.324693101000037],[-61.25405839799993,15.33266836100006],[-61.255523240999935,15.364569403000075],[-61.249256964999915,15.401068427000041],[-61.25422115799995,15.40298086100006],[-61.258371548999946,15.406317450000074],[-61.262928839999915,15.407904364000046],[-61.25601152299993,15.435939846000053],[-61.25767981699994,15.472601630000042],[-61.26716061099995,15.50779857000009],[-61.26862545499995,15.509914455000057],[-61.284047003999945,15.531398830000057],[-61.289621548999946,15.540961005000042],[-61.29954993399991,15.557196356000077],[-61.305897589999915,15.572455145000049],[-61.30768795499995,15.579250393000052],[-61.35732988199993,15.59829336100006],[-61.36974036399994,15.59593333500004],[-61.38463294199994,15.588364976000037],[-61.39757239499994,15.596625067000048],[-61.413726365999935,15.619574286000045],[-61.42593339799993,15.628485419000071],[-61.43724524599992,15.632635809000078],[-61.449208136999914,15.633083401000079],[-61.46898352799991,15.63385651200008],[-61.48062089799993,15.591009833000044],[-61.48888098899994,15.579250393000052],[-61.48119055899991,15.578558661000045],[-61.46906490799995,15.574286200000074],[-61.462147589999915,15.57298411700009],[-61.46727454299992,15.562974351000037],[-61.48399817599994,15.551581122000073],[-61.48888098899994,15.545070705000057],[-61.48892167899993,15.535711981000077],[-61.48485266799992,15.53034088700008],[-61.479359503999945,15.525458075000074],[-61.47520911399994,15.517767645000049],[-61.474273240999935,15.493475653000075],[-61.47207597599993,15.481390692000048],[-61.46556555899991,15.476141669000071],[-61.46003170499995,15.47288646000004],[-61.45425370999993,15.46482982000009],[-61.449777798999946,15.454657294000071],[-61.44786536399994,15.445135809000078],[-61.444203253999945,15.436835028000075],[-61.4212133449999,15.414740302000041],[-61.418080206999946,15.405951239000046],[-61.415679490999935,15.387640692000048],[-61.413726365999935,15.380560614000046],[-61.39956620999993,15.351141669000071],[-61.39500891799992,15.33307526200008],[-61.39321855399993,15.308294989000046],[-61.39093990799995,15.296291408000059],[-61.37828528599994,15.282049872000073],[-61.37279212099992,15.270697333000044],[-61.37328040299991,15.266424872000073],[-61.37279212099992,15.237209377000056],[-61.37612870999993,15.212836005000042],[-61.37409420499995,15.204820054000038],[-61.36286373599995,15.20180898600006]]]}}, ignore_index=True)
countries_geo = countries_geo.append({"name": "Grenada", "ID": "GRD", "geometry":{"type":"Polygon","coordinates":[[[-61.612945115999935,12.214422919000071],[-61.606678839999915,12.220282294000071],[-61.606027798999946,12.22337474200009],[-61.62767493399991,12.236721096000053],[-61.650502081999946,12.239732164000088],[-61.67145748599995,12.236070054000038],[-61.72964433499993,12.16665273600006],[-61.73029537699995,12.149318752000056],[-61.75104732999995,12.11009349200009],[-61.756418423999946,12.087836005000042],[-61.75377356699994,12.074164130000042],[-61.74885006399995,12.062648830000057],[-61.74596106699994,12.050930080000057],[-61.74950110599991,12.036322333000044],[-61.755848761999914,12.03025950700004],[-61.79051673099991,12.008368231000077],[-61.77554277299993,12.004339911000045],[-61.75694739499994,12.003404039000088],[-61.73997962099992,12.00690338700008],[-61.72964433499993,12.015814520000049],[-61.72175045499995,12.011053778000075],[-61.71324622299994,12.00726959800005],[-61.70425370999993,12.00454336100006],[-61.69493567599994,12.002834377000056],[-61.693430141999954,12.012274481000077],[-61.68936113199993,12.01976146000004],[-61.68297278599994,12.02537669500009],[-61.67442786399994,12.029486395000049],[-61.67442786399994,12.022040106000077],[-61.63158118399991,12.044094143000052],[-61.62604732999995,12.05304596600007],[-61.62572180899991,12.061224677000041],[-61.62450110599991,12.069037177000041],[-61.62157141799992,12.07493724200009],[-61.61636308499993,12.077297268000052],[-61.613840298999946,12.08038971600007],[-61.61945553299995,12.09674713700008],[-61.61978105399993,12.10455963700008],[-61.61310787699995,12.11985911700009],[-61.6087133449999,12.126776434000078],[-61.606312628999945,12.13377513200004],[-61.602772589999915,12.182928778000075],[-61.60456295499995,12.197455145000049],[-61.612945115999935,12.214422919000071]]]}}, ignore_index=True)
countries_geo = countries_geo.append({"name": "Liechtenstein", "ID": "LIE", "geometry":{"type":"Polygon","coordinates":[[[9.52115482500011,47.2628010050001],[9.504618368000138,47.24373240200002],[9.487358439000047,47.21001352900005],[9.484981323000085,47.176346334000115],[9.492629435000083,47.15980987600001],[9.503481486000112,47.14539215100011],[9.511853068000107,47.12937245700006],[9.512369832000047,47.10803009100006],[9.50286136800014,47.09469757200013],[9.487565145000104,47.083948874],[9.475886271000121,47.0732260140001],[9.477023153000118,47.06389841700006],[9.499554077000141,47.05935089100002],[9.560635620000141,47.05240041200004],[9.581202840000032,47.05687042300006],[9.608798055000136,47.080770773000054],[9.615722697000109,47.10676401800002],[9.605594116000077,47.13226633700005],[9.5818229570001,47.154900615000074],[9.552057332000118,47.16688954700005],[9.551953979000103,47.175571188000006],[9.561875854000078,47.19060902900007],[9.562909383000061,47.19774037700002],[9.554331095000123,47.211615499000104],[9.544822632000148,47.220322978000056],[9.540378458000134,47.22910797200005],[9.547096395000068,47.24303477000002],[9.530249878000092,47.253654277000024],[9.52115482500011,47.2628010050001]]]}}, ignore_index=True)
countries_geo = countries_geo.append({"name": "Monaco", "ID": "MCO", "geometry":{"type":"Polygon","coordinates":[[[7.43745403212602,43.74336054083465],[7.426246111000125,43.755464229000026],[7.406968628000072,43.76350555400002],[7.387538289000105,43.7578986620001],[7.372655477000052,43.74583221500002],[7.367262599000071,43.73412453300007],[7.365750207000076,43.72273028300003],[7.380722515000059,43.71927314100009],[7.404319061000081,43.71796907700008],[7.417956880000077,43.73090382500004],[7.432845087000089,43.739852548000044],[7.43745403212602,43.74336054083465]]]}}, ignore_index=True)
countries_geo = countries_geo.append({"name": "Saint Kitts and Nevis", "ID": "KNA", "geometry":{"type":"Polygon","coordinates":[[[-62.650461391999954,17.26561107000009],[-62.666859503999945,17.273504950000074],[-62.67813066299993,17.292222398000092],[-62.69546464799993,17.333238023000092],[-62.719960089999915,17.358547268000052],[-62.819569464999915,17.415838934000078],[-62.822336391999954,17.410101630000042],[-62.82664954299992,17.407171942000048],[-62.83885657499991,17.402167059000078],[-62.84357662699995,17.40106842700004],[-62.846547003999945,17.39996979400007],[-62.84923255099994,17.398138739000046],[-62.85313880099994,17.39472077000005],[-62.86107337099992,17.36229075700004],[-62.83161373599995,17.330145575000074],[-62.788726365999935,17.30467357000009],[-62.75694739499994,17.292303778000075],[-62.74404863199993,17.29059479400007],[-62.712554490999935,17.292303778000075],[-62.70335852799991,17.289129950000074],[-62.690297003999945,17.27496979400007],[-62.670480923999946,17.26316966400009],[-62.65973873599995,17.225490627000056],[-62.647043423999946,17.217189846000053],[-62.62474524599992,17.22528717700004],[-62.62482662699995,17.241848049000055],[-62.636830206999946,17.258205471000053],[-62.650461391999954,17.26561107000009]]]}}, ignore_index=True)
countries_geo = countries_geo.append({"name": "Saint Vincent and the Grenadines", "ID": "VCT", "geometry":{"type":"Polygon","coordinates":[[[-61.441395636999914,12.607896226000037],[-61.44831295499995,12.609930731000077],[-61.45555579299992,12.607082424000055],[-61.45677649599992,12.604437567000048],[-61.45466061099995,12.600775458000044],[-61.45567786399994,12.596584377000056],[-61.459828253999945,12.591457424000055],[-61.455922003999945,12.586086330000057],[-61.44322669199994,12.585150458000044],[-61.43272864499994,12.587836005000042],[-61.426625128999945,12.591864325000074],[-61.429351365999935,12.600490627000056],[-61.441395636999914,12.607896226000037]]]}}, ignore_index=True)
countries_geo = countries_geo.append({"name": "San Marino", "ID": "SMR", "geometry":{"type":"Polygon","coordinates":[[[12.4294503590001,43.892055514999996],[12.460456219000037,43.895259454000055],[12.478286774000082,43.917037885000084],[12.477493853000112,43.92005098400007],[12.478026206000095,43.92321640400006],[12.479576499000132,43.92580022500006],[12.482160321000038,43.92791895900005],[12.48309447400004,43.92920489800004],[12.490325196000128,43.93915858300009],[12.492392254000094,43.956418510999995],[12.48918831500012,43.9731099990001],[12.482160321000038,43.98256678600008],[12.453324871000092,43.97905278900005],[12.42138883600012,43.96721888500012],[12.411048669000138,43.95966101200004],[12.395653973000037,43.94840866400001],[12.385628745000105,43.924534153000124],[12.399581381000075,43.903217625000124],[12.4294503590001,43.892055514999996]]]}}, ignore_index=True)
countries_geo = countries_geo.append({"name": "Sao Tome and Principe", "ID": "STP", "geometry":{"type":"MultiPolygon","coordinates":[[[[6.68140709700009,0.40713125200005607],[6.641856316000087,0.41079336100006003],[6.609548373000052,0.390366929000038],[6.578298373000052,0.36456940300007545],[6.54078209700009,0.35187409100007017],[6.533050977000073,0.3481306010000935],[6.49781334700009,0.312689520000049],[6.495371941000087,0.306382554000038],[6.494313998000052,0.2999942080000437],[6.490244988000086,0.2909610050000424],[6.470876498000052,0.26788971600007017],[6.46851647200009,0.259955145000049],[6.4681095710000704,0.2398135440000715],[6.466319207000083,0.23102448100007678],[6.4616805350000845,0.22215403900008823],[6.4672957690000885,0.2124697940000715],[6.5026961600000845,0.09857819200004769],[6.505707227000073,0.0948753930000521],[6.509613477000073,0.09267812700005607],[6.513682488000086,0.08828359600005342],[6.5169376960000704,0.07811107000009088],[6.516612175000091,0.06997304900005474],[6.511729363000086,0.052720445000090876],[6.510101759000065,0.05141836100006003],[6.5163680350000845,0.03363678600004505],[6.526621941000087,0.024115302000041083],[6.536957227000073,0.02643463700007942],[6.544200066000087,0.04393138200003932],[6.5573022800000444,0.028265692000047693],[6.5677189460000704,0.0421410180000521],[6.578379754000082,0.07811107000009088],[6.582855665000068,0.07733795800004373],[6.616221550000091,0.07811107000009088],[6.618174675000091,0.0812035180000521],[6.633636915000068,0.09857819200004769],[6.641449415000068,0.10101959800005034],[6.652598504000082,0.10321686400004637],[6.660004102000073,0.10732656500005078],[6.653330925000091,0.12457916900007149],[6.659190300000091,0.1288516300000424],[6.6684676440000885,0.1310082050000574],[6.6745711600000845,0.13336823100007678],[6.703135613000086,0.18040599200008955],[6.7155867850000845,0.1954613300000574],[6.740082227000073,0.2185733090000781],[6.7485457690000885,0.23069896000004064],[6.7565210300000444,0.25006745000007413],[6.7605086600000845,0.26829661700008955],[6.760915561000047,0.2841657570000393],[6.7565210300000444,0.31085846600007017],[6.746104363000086,0.338080145000049],[6.7270613940000885,0.366929429000038],[6.7038680350000845,0.3918317730000922],[6.68140709700009,0.40713125200005607]]],[[[7.462738477000073,1.6745466170000896],[7.4597274100000845,1.6882998720000728],[7.448741082000083,1.693182684000078],[7.4212345710000704,1.6957054710000534],[7.4030054050000444,1.6997744810000768],[7.3852645190000885,1.6923281920000477],[7.3718367850000845,1.6771914730000503],[7.3665470710000704,1.6581078150000508],[7.366465691000087,1.6417910830000437],[7.3640242850000845,1.6293806010000935],[7.3559676440000885,1.620021877000056],[7.339366082000083,1.613104559000078],[7.330088738000086,1.6146507830000587],[7.329356316000087,1.5962588560000768],[7.3325301440000885,1.565334377000056],[7.343760613000086,1.5598819030000755],[7.358409050000091,1.5589053410000702],[7.372243686000047,1.5541445980000503],[7.381032748000052,1.537990627000056],[7.3873804050000444,1.5424665390000882],[7.394053582000083,1.5453962260000935],[7.395681186000047,1.5423851580000587],[7.398773634000065,1.534979559000078],[7.401377800000091,1.5311953800000424],[7.402517123000052,1.5420596370000794],[7.40211022200009,1.5507266300000424],[7.405772332000083,1.556463934000078],[7.418223504000082,1.5584984400000508],[7.42554772200009,1.5627302100000406],[7.430511915000068,1.5727399760000935],[7.435557488000086,1.5925967470000728],[7.434418165000068,1.6152204450000909],[7.4382430350000845,1.623928127000056],[7.452647332000083,1.6273460960000534],[7.461761915000068,1.6308047550000424],[7.45671634200005,1.6383324240000547],[7.443532748000052,1.6454531920000477],[7.428721550000091,1.6478539080000587],[7.434825066000087,1.658880927000041],[7.446136915000068,1.6654727230000503],[7.457367384000065,1.6699893250000741],[7.462738477000073,1.6745466170000896]]]]}}, ignore_index=True)
wh_region_table = {"AFG": "Eastern Mediterranean", "ALB": "Europe", "DZA": "Africa", "ASM": "", "AND": "Europe", "AGO": "Africa", "AIA": "", "ATG": "Americas", "ARG": "Americas", "ABW": "", "ARM": "Europe", "AUS": "Western Pacific", "AUT": "Europe", "AZE": "Europe", "BHS": "Americas", "BHR": "Eastern Mediterranean", "BGD": "Southeast Asia", "BRB": "Americas", "BLR": "Europe", "BEL": "Europe", "BLZ": "Americas", "BEN": "Africa", "BMU": "", "BTN": "Southeast Asia", "BOL": "Americas", "BIH": "Europe", "BWA": "Africa", "BRA": "Americas", "VGB": "", "BRN": "Western Pacific", "BGR": "Europe", "BFA": "Africa", "BDI": "Africa", "KHM": "Western Pacific", "CMR": "Africa", "CAN": "Americas", "CPV": "Africa", "CYM": "", "CAF": "Africa", "TCD": "Africa", "CHL": "Americas", "CHN": "Western Pacific", "COL": "Americas", "COM": "Africa", "COG": "Africa", "COK": "Western Pacific", "CRI": "Americas", "CIV": "Africa", "HRV": "Europe", "CUB": "Americas", "CYP": "Europe", "CZE": "Europe", "PRK": "Southeast Asia", "COD": "Africa", "DNK": "Europe", "DJI": "Eastern Mediterranean", "DMA": "Americas", "DOM": "Americas", "ECU": "Americas", "EGY": "Eastern Mediterranean", "SLV": "Americas", "GNQ": "Africa", "ERI": "Africa", "EST": "Europe", "ETH": "Africa", "FLK": "", "FJI": "Western Pacific", "FIN": "Europe", "FRA": "Europe", "GUF": "", "PYF": "", "GAB": "Africa", "GMB": "Africa", "GEO": "Europe", "DEU": "Europe", "GHA": "Africa", "GIB": "", "GRC": "Europe", "GRL": "", "GRD": "Americas", "GLP": "", "GUM": "", "GTM": "Americas", "GIN": "Africa", "GNB": "Africa", "GUY": "Americas", "HTI": "Americas", "": "", "HND": "Americas", "HUN": "Europe", "ISL": "Europe", "IND": "Southeast Asia", "IDN": "Southeast Asia", "IRN": "Eastern Mediterranean", "IRQ": "Eastern Mediterranean", "IRL": "Europe", "ISR": "Europe", "ITA": "Europe", "JAM": "Americas", "JPN": "Western Pacific", "JOR": "Eastern Mediterranean", "KAZ": "Europe", "KEN": "Africa", "KIR": "Western Pacific", "KWT": "Eastern Mediterranean", "KGZ": "Europe", "LAO": "Western Pacific", "LVA": "Europe", "LBN": "Eastern Mediterranean", "LSO": "Africa", "LBR": "Africa", "LBY": "Eastern Mediterranean", "LTU": "Europe", "LIE": "", "LUX": "Europe", "MDG": "Africa", "MWI": "Africa", "MYS": "Western Pacific", "MDV": "Southeast Asia", "MLI": "Africa", "MLT": "Europe", "MHL": "Western Pacific", "MTQ": "", "MRT": "Africa", "MUS": "Africa", "MEX": "Americas", "FSM": "Western Pacific", "MCO": "Europe", "MNG": "Western Pacific", "MNE": "Europe", "MSR": "", "MAR": "Eastern Mediterranean", "MOZ": "Africa", "MMR": "Southeast Asia", "NAM": "Africa", "NRU": "Western Pacific", "NPL": "Southeast Asia", "NLD": "Europe", "NZL": "Western Pacific", "NIC": "Americas", "NER": "Africa", "NGA": "Africa", "NIU": "Western Pacific", "NOR": "Europe", "OMN": "Eastern Mediterranean", "PAK": "Eastern Mediterranean", "PLW": "Western Pacific", "PAN": "Americas", "PNG": "Western Pacific", "PRY": "Americas", "PER": "Americas", "PHL": "Western Pacific", "POL": "Europe", "PRT": "Europe", "QAT": "Eastern Mediterranean", "KOR": "Western Pacific", "MDA": "Europe", "ROU": "Europe", "RUS": "Europe", "RWA": "Africa", "KNA": "Americas", "LCA": "Americas", "VCT": "Americas", "WSM": "Western Pacific", "SMR": "Europe", "STP": "Africa", "SAU": "Eastern Mediterranean", "SEN": "Africa", "SRB": "Europe", "SYC": "Africa", "SLE": "Africa", "SGP": "Western Pacific", "SVK": "Europe", "SVN": "Europe", "SLB": "Western Pacific", "SOM": "Eastern Mediterranean", "ZAF": "Africa", "ESP": "Europe", "SSD": "Africa", "LKA": "Southeast Asia", "SDN": "Eastern Mediterranean", "SUR": "Americas", "SWZ": "Africa", "SWE": "Europe", "CHE": "Europe", "SYR": "Eastern Mediterranean", "TJK": "Europe", "THA": "Southeast Asia", "MKD": "Europe", "TLS": "Southeast Asia", "TGO": "Africa", "TON": "Western Pacific", "TTO": "Americas", "TUN": "Eastern Mediterranean", "TUR": "Europe", "TKM": "Europe", "TUV": "Western Pacific", "UGA": "Africa", "UKR": "Europe", "ARE": "Eastern Mediterranean", "GBR": "Europe", "TZA": "Africa", "USA": "Americas", "URY": "Americas", "UZB": "Europe", "VUT": "Western Pacific", "VEN": "Americas", "VNM": "Western Pacific", "PSE": "", "YEM": "Eastern Mediterranean", "ZMB": "Africa", "ZWE": "Africa"}
iso3_name_table = dict(zip(countries_geo["ID"], countries_geo["name"]))
# download US geo data
states_geo = pd.read_csv("states_geo.tsv", sep="\t", header=None, names=["ID", "state", "geometry"])
states_geo.loc[:, "geometry"] = states_geo["geometry"].apply(json.loads)
counties_geo = pd.read_csv("counties_geo.tsv", sep="\t", header=None, names=["ID", "state", "geometry"])
counties_geo.loc[:, "geometry"] = counties_geo["geometry"].apply(json.loads)
us_state_to_abbrev = {"Alabama": "AL", "Alaska": "AK", "Arizona": "AZ", "Arkansas": "AR", "California": "CA", "Colorado": "CO", "Connecticut": "CT", "Delaware": "DE", "Florida": "FL", "Georgia": "GA", "Hawaii": "HI", "Idaho": "ID", "Illinois": "IL", "Indiana": "IN", "Iowa": "IA", "Kansas": "KS", "Kentucky": "KY", "Louisiana": "LA", "Maine": "ME", "Maryland": "MD", "Massachusetts": "MA", "Michigan": "MI", "Minnesota": "MN", "Mississippi": "MS", "Missouri": "MO", "Montana": "MT", "Nebraska": "NE", "Nevada": "NV", "New Hampshire": "NH", "New Jersey": "NJ", "New Mexico": "NM", "New York": "NY", "North Carolina": "NC", "North Dakota": "ND", "Ohio": "OH", "Oklahoma": "OK", "Oregon": "OR", "Pennsylvania": "PA", "Rhode Island": "RI", "South Carolina": "SC", "South Dakota": "SD", "Tennessee": "TN", "Texas": "TX", "Utah": "UT", "Vermont": "VT", "Virginia": "VA", "Washington": "WA", "West Virginia": "WV", "Wisconsin": "WI", "Wyoming": "WY", "District of Columbia": "DC", "American Samoa": "AS", "Guam": "GU", "Northern Mariana Islands": "MP", "Puerto Rico": "PR", "United States Minor Outlying Islands": "UM", "U.S. Virgin Islands": "VI"}
# define shared columns
metakeys = ["geometry", "name", "population", "iso3", "admin1", "lat", "long", "cases", "dates_list", "losses"]


# global data read-in & numpy conversion
print("reading in global epi data", file=sys.stderr)
global_epi = pd.read_csv("time_series_covid19_confirmed_global.csv")
dates_list_global = pd.to_datetime(list(global_epi.loc[:, "1/22/20":]), format="%m/%d/%y").strftime("%Y-%m-%d")
global_cases = list(global_epi.loc[:, "1/22/20":].to_numpy())
global_epi = global_epi.loc[:, :"Long"]
global_epi["cases"] = global_cases
global_epi["losses"] = list(pd.read_csv("time_series_covid19_deaths_global.csv").loc[:, "1/22/20":].to_numpy())
# global geo matcher
global_epi["UID"] = global_epi.index.values
global_data = pd.merge(global_epi, loc_lookup[["UID", "Population"]], on="UID", how="left")
global_data = global_data.rename(columns={"Country/Region":"name","Province/State":"admin1","Lat":"lat","Long":"long","Population":"population"})
global_data.loc[:, "name"] = global_data["name"].str.replace("*","", regex=False)
global_data = pd.merge(global_data, countries_geo, on="name", how="left")
global_data["iso3"] = global_data["ID"]
global_data["dates_list"] = [dates_list_global]*len(global_data)
global_data = global_data[metakeys]
missing_filter = global_data.drop(columns=["admin1", "population"]).isna().any(axis=1)
missing_provinces = global_data[missing_filter]
global_data = global_data[~missing_filter]
global_data["admin2"] = None


# US data read-in & numpy conversion
print("reading in county-level epi data", file=sys.stderr)
counties_epi = pd.read_csv("time_series_covid19_confirmed_US.csv")
dates_list_counties = pd.to_datetime(list(counties_epi.loc[:, "1/22/20":]), format="%m/%d/%y").strftime("%Y-%m-%d")
counties_cases = list(counties_epi.loc[:, "1/22/20":].to_numpy())
counties_epi = counties_epi.loc[:, :"Long_"]
counties_epi["cases"] = counties_cases
counties_epi["losses"] = list(pd.read_csv("time_series_covid19_deaths_US.csv").loc[:, "1/22/20":].to_numpy())
# US geo matcher
counties_epi["ID"] = counties_epi["Province_State"].apply(
    lambda x: "USA_US-"+us_state_to_abbrev[x]+"_" if x in us_state_to_abbrev else "USA_" ) + \
    counties_epi["FIPS"].apply(lambda x: "{:05d}".format(int(x)) if pd.notna(x) else "None")
county_data = pd.merge(counties_epi, counties_geo, on="ID", how="left")
county_data = pd.merge(county_data, loc_lookup[["UID", "Population"]], on="UID", how="left")
county_data = county_data.rename(columns={"Admin2":"name","Province_State":"admin1","Lat":"lat","Long_":"long","Population":"population"})
county_data["dates_list"] = [dates_list_counties]*len(county_data)
county_data = county_data[metakeys]
missing_filter = county_data.drop(columns=["admin1", "population"]).isna().any(axis=1)
missing_counties = county_data[missing_filter]
county_data = county_data[~missing_filter]
county_data["admin2"] = county_data["name"]
county_data["iso3"] = "USA"


# gather global and US data
print("gathering and patching", file=sys.stderr)
all_data = global_data.append(county_data)
all_data = all_data.fillna(np.nan).replace([np.nan], [None])
set_loc_id = lambda x: "{}_{}_{}".format(x["iso3"], x["admin1"], x["admin2"])
all_data["location_id"] = all_data.apply(set_loc_id, axis=1)
# generate aggregate entries
def sumdata(x):
    if len(x) <= 1:
        return None
    y = x.iloc[0]
    y["cases"] = np.sum(x["cases"].apply(lambda y: y[:min(x["cases"].apply(len))]))
    y["losses"] = np.sum(x["losses"].apply(lambda y: y[:min(x["losses"].apply(len))]))
    y["population"] = np.sum(x["population"])
    return pd.DataFrame([y])
summed_countries = all_data.groupby(["iso3"]).apply(sumdata).drop(columns=["geometry"])
summed_countries["admin1"] = None
summed_countries["admin2"] = None
summed_countries["ID"] = summed_countries["iso3"]
summed_countries = pd.merge(summed_countries, countries_geo[["ID", "geometry"]], on="ID", how="left").drop(columns=["ID"])
summed_countries["location_id"] = summed_countries.apply(set_loc_id, axis=1)
summed_countries = summed_countries.loc[~summed_countries["location_id"].isin(all_data["location_id"])]
summed_provinces = all_data.groupby(["iso3", "admin1"]).apply(sumdata).drop(columns=["geometry"])
summed_provinces["admin2"] = None
summed_provinces["name"] = summed_provinces["admin1"]
summed_provinces["ID"] = summed_provinces["admin1"].apply(
    lambda x: "USA_US-" + us_state_to_abbrev[x] if x in us_state_to_abbrev else None )
summed_provinces = pd.merge(summed_provinces, states_geo[["ID", "geometry"]], on="ID", how="left").drop(columns=["ID"])
# TODO: handle non-US-state (ie CHN, CAN, AUS province) case above (lower priority; need geo data)
summed_provinces["location_id"] = summed_provinces.apply(set_loc_id, axis=1)
summed_provinces = summed_provinces.loc[~summed_provinces["location_id"].isin(all_data["location_id"])]
all_data = all_data.append(summed_countries).append(summed_provinces).reset_index(drop=True)
# set admin_level, etc from geo
all_data["admin_level"] = 2
all_data.loc[pd.isna(all_data["admin2"]), "admin_level"] = 1
all_data.loc[pd.isna(all_data["admin1"]), "admin_level"] = 0
all_data["wh_region"] = all_data["iso3"].apply(lambda x: wh_region_table[x] if x in wh_region_table else "")
all_data["country_name"] = all_data["iso3"].apply(lambda x: iso3_name_table[x] if x in iso3_name_table else "")
all_data["admin1"] = all_data["admin1"].fillna("None")
all_data["admin2"] = all_data["admin2"].fillna("None")
# query for num_subnational
all_data["num_subnational"] = 0
def get_sub(level):
    def f(x):
        x.loc[pd.isna(x[level]), "num_subnational"] = len(x) - 1
        return x
    return f
all_data = all_data.groupby(["iso3"]).apply(get_sub("admin1"))
all_data = all_data.groupby(["iso3", "admin1"]).apply(get_sub("admin2"))

# fill blank with None and export to next step
print("exporting to parallel", file=sys.stderr)
all_data = all_data.fillna(np.nan).replace([np.nan], [None])
all_data.to_json("/dev/stdout", orient="records", lines=True)
